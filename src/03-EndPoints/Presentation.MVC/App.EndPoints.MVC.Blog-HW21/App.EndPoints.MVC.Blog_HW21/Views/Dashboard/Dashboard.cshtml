@using App.EndPoints.MVC.Blog_HW21.Models.Category;
@using App.Domain.Core.CategoryAgg.Entities;
@using App.EndPoints.MVC.Blog_HW21.Models.Dashboard
@{
    Layout = "~/Views/Shared/DashbordLayout.cshtml";
    var categories = ViewBag.Catrgories as List<Category>;
    var category = ViewBag.category as CategoryViewModel;
    var header = ViewBag.Heder as HederDashboardViewModel;

    // اگر مقدار null بود یعنی تبدیل موفق نبود یا مقدار وجود نداشت
    if (category == null)
    {
        // نمونه جدید می‌سازیم تا به خصوصیاتش دسترسی داشته باشیم
        category = new CategoryViewModel
                {
                    Title = "عنوان پیش‌فرض",
                    Description = "توضیح پیش‌فرض"
                };
    }
    // @if (TempData["SuccessMessage"] != null)
    // {
    //     <script>
    //         alert('@TempData["SuccessMessage"]');
    //     </script>
    // }


}
@section Styles {
<link rel="stylesheet" href="~/css/Dashboard.css" />
}

<!-- Floating background elements -->
<div class="floating-element" style="width: 80px; height: 80px; top: 10%; left: 5%; animation-delay: 0s;"></div>
<div class="floating-element" style="width: 60px; height: 60px; top: 70%; right: 10%; animation-delay: 2s;"></div>
<div class="floating-element" style="width: 100px; height: 100px; bottom: 20%; left: 8%; animation-delay: 4s;"></div>

<div class="container">
    <!-- Admin Header -->
    <header class="admin-header">
        <a  style="text-decoration:none" asp-action="Logout"> <button type="submit" class="btn btn-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> خروج
            </button>
        </a>
        <div class="author-avatar">م.ح</div>
        <div class="author-info">
            <h1 class="author-name"> @header.FullName</h1>
            <div class="author-stats">
                <div class="stat-item">
                    <i class="fas fa-file-alt"></i>
                    <span>تعداد پست‌ها: <span class="stat-number">@header.CountPost</span></span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-th-large"></i>
                    <span>دسته‌بندی‌ها: <span class="stat-number">@header.CountCategory</span></span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-comments"></i>
                    <span>نظرات: <span class="stat-number">@header.CountComment</span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard -->
    <div class="dashboard">
        <!-- Categories Box -->
        <div class="box">
            <div class="box-header">
                <h2 class="box-title">
                    <i class="fas fa-th-large"></i>
                    مدیریت دسته‌بندی‌ها
                </h2>
                <div class="box-actions">
                    <button class="btn btn-primary" onclick="openCategoryModal()">
                        <i class="fas fa-plus"></i>
                        ایجاد دسته‌بندی
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>نام دسته‌بندی</th>
                            <th>تعداد پست‌ها</th>
                            <th style="text-align: center;">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var item in categories)
                        {
                        <tr>
                            <td>
                                    <div class="category-name">@item.Name </div>
                            </td>
                            <td>
                                    <span class="category-count">@item.Posts.Count</span>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-warning btn-sm" onclick="editCategory(1)">
                                        <i class="fas fa-edit"></i>
                                        ویرایش
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCategory(1)">
                                        <i class="fas fa-trash"></i>
                                        حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                        }
                        @* <tr> *@
                        @*     <td> *@
                        @*         <div class="category-name">شعر</div> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <span class="category-count">۱۸ پست</span> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <div class="actions"> *@
                        @*             <button class="btn btn-warning btn-sm" onclick="editCategory(2)"> *@
                        @*                 <i class="fas fa-edit"></i> *@
                        @*                 ویرایش *@
                        @*             </button> *@
                        @*             <button class="btn btn-danger btn-sm" onclick="deleteCategory(2)"> *@
                        @*                 <i class="fas fa-trash"></i> *@
                        @*                 حذف *@
                        @*             </button> *@
                        @*         </div> *@
                        @*     </td> *@
                        @* </tr> *@
                        @* <tr> *@
                        @*     <td> *@
                        @*         <div class="category-name">مقاله</div> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <span class="category-count">۱۲ پست</span> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <div class="actions"> *@
                        @*             <button class="btn btn-warning btn-sm" onclick="editCategory(3)"> *@
                        @*                 <i class="fas fa-edit"></i> *@
                        @*                 ویرایش *@
                        @*             </button> *@
                        @*             <button class="btn btn-danger btn-sm" onclick="deleteCategory(3)"> *@
                        @*                 <i class="fas fa-trash"></i> *@
                        @*                 حذف *@
                        @*             </button> *@
                        @*         </div> *@
                        @*     </td> *@
                        @* </tr> *@
                        @* <tr> *@
                        @*     <td> *@
                        @*         <div class="category-name">نقد و بررسی</div> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <span class="category-count">۸ پست</span> *@
                        @*     </td> *@
                        @*     <td> *@
                        @*         <div class="actions"> *@
                        @*             <button class="btn btn-warning btn-sm" onclick="editCategory(4)"> *@
                        @*                 <i class="fas fa-edit"></i> *@
                        @*                 ویرایش *@
                        @*             </button> *@
                        @*             <button class="btn btn-danger btn-sm" onclick="deleteCategory(4)"> *@
                        @*                 <i class="fas fa-trash"></i> *@
                        @*                 حذف *@
                        @*             </button> *@
                        @*         </div> *@
                        @*     </td> *@
                        @* </tr> *@
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Posts Box -->
        <div class="box">
            <div class="box-header">
                <h2 class="box-title">
                    <i class="fas fa-file-alt"></i>
                    مدیریت پست‌ها
                </h2>
                <div class="box-actions">
                    <button class="btn btn-primary" onclick="openPostModal()">
                        <i class="fas fa-plus"></i>
                        ایجاد پست
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: center;">تصویر</th>
                            <th style="text-align: center;">عنوان پست</th>
                            <th style="text-align: center;">دسته‌بندی</th>
                            <th style="text-align: center;">تاریخ ایجاد</th>
                            <th style="text-align: center;">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="post-image">
                                    <i class="fas fa-book-open"></i>
                                </div>
                            </td>
                            <td>
                                <div class="post-title">پروانه‌های سفید: داستانی از امید و تحول</div>
                            </td>
                            <td>
                                <span class="post-category">داستان کوتاه</span>
                            </td>
                            <td>
                                <div class="post-date">۱۴۰۲/۱۰/۱۵</div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-warning btn-sm" onclick="editPost(1)">
                                        <i class="fas fa-edit"></i>
                                        ویرایش
                                    </button>
                                    <button class="btn btn-outline btn-sm" onclick="manageComments(1)">
                                        <i class="fas fa-comments"></i>
                                        نظرات
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePost(1)">
                                        <i class="fas fa-trash"></i>
                                        حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="post-image">
                                    <i class="fas fa-feather-alt"></i>
                                </div>
                            </td>
                            <td>
                                <div class="post-title">در آغوش باد: مجموعه‌ای از اشعار عاشقانه</div>
                            </td>
                            <td>
                                <span class="post-category">شعر</span>
                            </td>
                            <td>
                                <div class="post-date">۱۴۰۲/۱۰/۱۲</div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-warning btn-sm" onclick="editPost(2)">
                                        <i class="fas fa-edit"></i>
                                        ویرایش
                                    </button>
                                    <button class="btn btn-outline btn-sm" onclick="manageComments(2)">
                                        <i class="fas fa-comments"></i>
                                        نظرات
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePost(2)">
                                        <i class="fas fa-trash"></i>
                                        حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="post-image">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                            </td>
                            <td>
                                <div class="post-title">تاثیر ادبیات بر رشد فرهنگی جامعه</div>
                            </td>
                            <td>
                                <span class="post-category">مقاله</span>
                            </td>
                            <td>
                                <div class="post-date">۱۴۰۲/۱۰/۱۰</div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-warning btn-sm" onclick="editPost(3)">
                                        <i class="fas fa-edit"></i>
                                        ویرایش
                                    </button>
                                    <button class="btn btn-outline btn-sm" onclick="manageComments(3)">
                                        <i class="fas fa-comments"></i>
                                        نظرات
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePost(3)">
                                        <i class="fas fa-trash"></i>
                                        حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="post-image">
                                    <i class="fas fa-star"></i>
                                </div>
                            </td>
                            <td>
                                <div class="post-title">نقدی بر رمان "سایه‌های بلند": تحلیل شخصیت‌پردازی</div>
                            </td>
                            <td>
                                <span class="post-category">نقد و بررسی</span>
                            </td>
                            <td>
                                <div class="post-date">۱۴۰۲/۱۰/۰۸</div>
                            </td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-warning btn-sm" onclick="editPost(4)">
                                        <i class="fas fa-edit"></i>
                                        ویرایش
                                    </button>
                                    <button class="btn btn-outline btn-sm" onclick="manageComments(4)">
                                        <i class="fas fa-comments"></i>
                                        نظرات
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePost(4)">
                                        <i class="fas fa-trash"></i>
                                        حذف
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Category Modal -->
<div class="modal" id="categoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="categoryModalTitle">ایجاد دسته‌بندی جدید</h3>
            <button class="close-modal" onclick="closeCategoryModal()">&times;</button>
        </div>
        <form id="categoryForm" method="post" asp-action="CreateCategories">
            <label>@ViewBag.Massage‌</label>
            
            <div class="form-group">
                <label for="categoryName">نام دسته‌بندی</label>
                <input type="text" id="categoryName" name="Title" value=" @category.Title" class="form-control" placeholder="نام دسته‌بندی را وارد کنید" required>
            </div>

            <div class="form-group">
                <label for="categoryDescription">توضیحات</label>
                <textarea id="categoryDescription" name="Description" value=" @category.Description" class="form-control" placeholder="توضیحات دسته‌بندی را وارد کنید"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">انصراف</button>
                <button type="submit" class="btn btn-primary">ذخیره</button>
            </div>
        </form>
    </div>
</div>

<!-- Post Modal -->
<div class="modal" id="postModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="postModalTitle">ایجاد پست جدید</h3>
            <button class="close-modal" onclick="closePostModal()">&times;</button>
        </div>

        <form id="postForm" enctype="multipart/form-data" method="post">
          <div style="display:flex;flex-direction:row ;justify-content:space-between;">
                <div style="display:flex;flex-direction:column; width:450px;padding-left:5px">
                    <div class="form-group">
                        <label for="postTitle">عنوان پست</label>
                        <input type="text" id="postTitle" class="form-control" placeholder="عنوان پست را وارد کنید" required>
                    </div>
                    <div class="form-group">
                        <label for="imageInput">آپلود عکس با فرمت   Max-size = 2mb ----- JPG/PNG </label>
                        <input type="file" id="imageInput" accept=".jpg,.jpeg,.png" max-size="2097152">
                    </div>
                    <div class="form-group">
                        <label for="postCategory">دسته‌بندی</label>
                        <select id="postCategory" class="form-control" required>
                            <option value="">انتخاب دسته‌بندی</option>
                            <option value="1">داستان کوتاه</option>
                            <option value="2">شعر</option>
                            <option value="3">مقاله</option>
                            <option value="4">نقد و بررسی</option>
                        </select>
                    </div>
              </div>
              
                <div class="form-group" style="width:450px;padding:5px">
                    <img id="imagePreview" src="#" alt="Preview Image" style="display:none; width:450px;height:256px; border-radius:15px" />
                </div>
          </div>
            <div class="form-group">
                <label for="postContent">محتوا</label>
                <textarea id="postContent" class="form-control" placeholder="محتویات پست را وارد کنید" required></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePostModal()">انصراف</button>
                <button type="submit" class="btn btn-primary">ذخیره</button>
            </div>
        </form>
    </div>
</div>

<script>
       

    
   
    // Category Modal Functions
    function openCategoryModal() {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('categoryModalTitle').textContent = 'ایجاد دسته‌بندی جدید';
        document.getElementById('categoryForm').reset();

    }
     

    function closeCategoryModal() {
        document.getElementById('categoryModal').classList.remove('active');
    }
    // ________________________________
       document.addEventListener("DOMContentLoaded", function() {
      var showModalRaw = '@(ViewBag.ShowCategoryModal ?? "false")';
      var showModal = (showModalRaw.toLowerCase() === 'true');

      if (showModal) {
        openCategoryModal();
      }
    });

    function openCategoryModal() {
      console.log("openCategoryModal called");
      document.getElementById('categoryModal').classList.add('active');
      document.getElementById('categoryModalTitle').textContent = 'ایجاد دسته‌بندی جدید';
      document.getElementById('categoryForm').reset();
    }
    // ---------------------------------

    function editCategory(id) {
        document.getElementById('categoryModal').classList.add('active');
        document.getElementById('categoryModalTitle').textContent = 'ویرایش دسته‌بندی';
        // In a real app, you would load category data here
        document.getElementById('categoryName').value = 'داستان کوتاه';
        document.getElementById('categoryDescription').value = 'دسته‌بندی مربوط به داستان‌های کوتاه';
    }

    function deleteCategory(id) {
        if (confirm('آیا از حذف این دسته‌بندی اطمینان دارید؟')) {
            alert('دسته‌بندی با موفقیت حذف شد');
        }
    }

    // Post Modal Functions
    function openPostModal() {
        document.getElementById('postModal').classList.add('active');
        document.getElementById('postModalTitle').textContent = 'ایجاد پست جدید';
        document.getElementById('postForm').reset();
    }

    function closePostModal() {
        document.getElementById('postModal').classList.remove('active');
    }

    function editPost(id) {
        document.getElementById('postModal').classList.add('active');
        document.getElementById('postModalTitle').textContent = 'ویرایش پست';
        // In a real app, you would load post data here
        document.getElementById('postTitle').value = 'پروانه‌های سفید: داستانی از امید و تحول';
        document.getElementById('postCategory').value = '1';
        document.getElementById('postContent').value = 'محتویات پست...';
    }

    function deletePost(id) {
        if (confirm('آیا از حذف این پست اطمینان دارید؟')) {
            alert('پست با موفقیت حذف شد');
        }
    }

    function manageComments(id) {
        alert('مدیریت نظرات پست شماره ' + id);
    }

    // Form Submissions
    // document.getElementById('categoryForm').addEventListener('submit', function(e) {
    //     e.preventDefault();
    //     const categoryName = document.getElementById('categoryName').value;
    //     alert(`دسته‌بندی "${categoryName}" با موفقیت ذخیره شد`);
    //     closeCategoryModal();
    // });

    document.getElementById('postForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const postTitle = document.getElementById('postTitle').value;
        alert(`پست "${postTitle}" با موفقیت ذخیره شد`);
        closePostModal();
    });

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    });
    //image preview
        const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');

    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();

            reader.addEventListener('load', function() {
                imagePreview.setAttribute('src', this.result);
                imagePreview.style.display = 'block';
            });

            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
            imagePreview.setAttribute('src', '#');
        }
    });
   
</script>